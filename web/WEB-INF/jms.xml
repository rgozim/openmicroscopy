<?xml version="1.0" encoding="UTF-8"?>
<!--
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#
# Copyright (C) 2005 Open Microscopy Environment
#       Massachusetts Institue of Technology,
#       National Institutes of Health,
#       University of Dundee
#
#
#
#    This library is free software; you can redistribute it and/or
#    modify it under the terms of the GNU Lesser General Public
#    License as published by the Free Software Foundation; either
#    version 2.1 of the License, or (at your option) any later version.
#
#    This library is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
#    Lesser General Public License for more details.
#
#    You should have received a copy of the GNU Lesser General Public
#    License along with this library; if not, write to the Free Software
#    Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
#
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
-->

<!--
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# Written by:  Josh Moore <josh.moore@gmx.de>
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
-->

<!--

	Testing JMS from ActiveMQ
	TODO: see Lingo! (full callbacks!)
 
-->

<!DOCTYPE beans PUBLIC "-//SPRING//DTD BEAN//EN" "http://www.springframework.org/dtd/spring-beans.dtd">

<beans>	

  <bean id="broker" class="org.activemq.spring.BrokerFactoryBean">
    <property name="config" value="WEB-INF/vm.xml"/>
  </bean>
	
  <!-- a pooling based JMS provider -->
  <bean id="jmsFactory" class="org.activemq.pool.PooledConnectionFactory">
    <property name="connectionFactory">
      <bean class="org.activemq.ActiveMQConnectionFactory">
        <property name="brokerURL" value="vm://localhost"/>
		<property name="useEmbeddedBroker" value="false"/>
      </bean>
    </property>
  </bean>

  <!-- Spring JMS Template -->
  <bean id="jmsTemplate" class="org.springframework.jms.core.JmsTemplate">
    <property name="connectionFactory" ref="jmsFactory"/>
    <property name="defaultDestinationName" value="TEST"/>
  </bean>

	
	<!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
		Everything below here is actually for the client. MDB's and such
	~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~	-->
	<!--
    || A JCA container for ActiveMQ
    -->

	<bean id="activeMQContainer" class="org.activemq.jca.JCAContainer">

	<!--
	 the work manager (thread pool) for this container 
	-->
	<property name="workManager">
		<bean id="workManager" class="org.activemq.work.SpringWorkManager"></bean>
	</property>
	
	<!-- the JCA Resource Adapter -->
	<property name="resourceAdapter">
		<bean id="activeMQResourceAdapter" class="org.activemq.ra.ActiveMQResourceAdapter">
			<property name="serverUrl" value="vm://localhost"/>
		</bean>
	</property>

	</bean>

	<!--
    || an inbound message connector using a stateless, thread safe MessageListener
	-->

	<bean id="mdb" factory-method="addConnector" 
		                       factory-bean="activeMQContainer" singleton="true">
	<!-- subscription details -->

	<!-- TODO: (don't need pooling if reentrant)
	Two desitinations: ALL.Topic
					   ${host}${user}.Queue 
		
		msgs to All.Topic are handled by one Handler.
		msgs to <me>.Queue are handled by another.
		Callbacks are registered with <me>.Queue by hash.put(corrId,callback) {WeakRef?}
		
		Other possible Topics:
		 * NewClasses.Topic
		 * NewImages.Topic
		 * DeletedImages.Topic
		 * Deletion.Topic
		 * ...
	-->
	<property name="activationSpec">
		<bean class="org.activemq.ra.ActiveMQActivationSpec">

		<property name="destination">
			<value>ASYN</value>
		</property>

		<property name="destinationType">
			<value>javax.jms.Queue</value>
		</property>
		</bean>
	</property>
	
	<property name="ref" value="pooledBean"/>
	
	</bean>

	<!--
    || Message Driven POJOs
    -->

	<!-- a thread safe non-pooled MessageListener i.e. Dispatcher -->
	<bean id="bean" class="org.openmicroscopy.omero.server.itests.JmsTest" singleton="true"/>

	<!--
 	a pooled, non-thread safe MessageListener using ProxyFactoryBean 
	-->
  	<bean id="pooledBean" class="org.activemq.jca.TargetSourceMessageListener">
    <property name="targetSource">
      <bean id="pooledBeanTargetSource" class="org.springframework.aop.target.CommonsPoolTargetSource">
        <property name="targetBeanName">
          <value>pooledBeanTarget</value>
        </property>
        <property name="maxSize">
          <value>25</value>
        </property>
      </bean>
    </property>
  </bean>
  <bean id="pooledBeanTarget" class="org.openmicroscopy.omero.server.itests.JmsTest" singleton="false">
  </bean>
  
</beans>
