<?xml version="1.0" encoding="utf-8"?>
<!-- TODO add properties goal to update pref.properties -->
<project name="common" default="install" basedir=".">
    
	<!-- Default overrides -->
	<property name="javac.source" value="1.4"/>
	<property name="javac.target" value="1.4"/>
    
	<import file="classpath.xml"/>
	
	<!-- Local properties -->
	<property name="ddl.file" value="ddl.sql" />
	
	<!-- Lifecycle Overrides -->
	<target name="prepare" depends="lifecycle.prepare,load-hibernate"/>
	<target name="generate" depends="lifecycle.generate,dsl,hib" unless="generate.skip"/>
	<!-- TODO generate.skip not working -->

    <!-- = = = = = = = = = = = = = = = = =
          home grown code-gen          
         = = = = = = = = = = = = = = = = = -->
	
	<target name="dsl-init">
		<taskdef classname="ome.dsl.DSLTask" classpathref="omero.classpath" name="dsl"/>
		<is-done name="dsl" srcdir="${resrc.dir}" includes="${dsl.pat}"/>
	</target>
	
	<target name="dsl" depends="dsl-init" unless="dsl.not.required">
		<dsl destdir="${resrc.dest}/">
			<fileset dir="${resrc.dir}">
				<include name="${dsl.pat}"/>
			</fileset>
		</dsl>
		<done name="dsl"/>
	</target>

	<target name="api-init">
		<taskdef classname="ome.dsl.APITask" classpathref="omero.classpath" name="api"/>
		<is-done name="api" srcdir="${src.dir}/ome/api" includes="${api.pat}"/>
	</target>
	
	<target name="api" depends="api-init" unless="api.not.required">
		<api destdir="${resrc.dest}/">
			<fileset dir="${src.dir}/ome/api">
				<include name="${api.pat}"/>
			</fileset>
		</api>
		<done name="api"/>
	</target>
	
    <!-- = = = = = = = = = = = = = = = = =
          hibernate code-gen  
         = = = = = = = = = = = = = = = = = -->
	
	<target name="hib-init">
		<is-done name="hib" srcdir="${resrc.dest}" includes="${hbm.pat}"/>
	</target>
	
	<target name="hib" depends="dsl,hib-init" unless="hib.not.required">
		<concat destfile="${resrc.dest}/hibernate.properties" append="true">
			<filelist dir="${etc.dir}">
				<file name="hibernate.properties"/>
				<file name="local.properties"/>
			</filelist>
		</concat>

		<hibernate>			
			<hbm2java destdir="${src.dest}"/>
			<!-- hbm2java destdir="${dest.dir}/jdk5" generics="true" ejb3="true"/ -->
			<hbm2ddl destdir="${resrc.dest}" outputfilename="${ddl.file}" drop="false" console="false" format="true" export="false" />
			<hbm2cfgXml destdir="${resrc.dest}"/>
		</hibernate>
		<done name="hib"/>
		<delete>
			<fileset dir="${src.dest}" includes="**/*.java">
				<present present="both" targetdir="${src.dir}"/>
			</fileset>
		</delete>
	</target>

    <!-- = = = = = = = = = = = = = = = = =
          misc          
         = = = = = = = = = = = = = = = = = -->
	
	<target name="check-db" depends="lifecycle.prepare">
		<sql_run>
			<transaction> select 'database exists.' </transaction>
		</sql_run>
	</target>

	<target name="reload-db" depends="lifecycle.prepare,generate">
		<sql_run>
  			<transaction src="${resrc.dest}/${ddl.file}"/>
  			<transaction src="${resrc.dest}/data.sql"/>
		</sql_run>
	</target>

	<target name="adduser" depends="lifecycle.prepare">
                <input
                        message="Please enter username:"
                        addproperty="db.user"
                />
                <sql_run>
                        <transaction>
 insert into experimenter
 (id, version, omename, firstname, lastname)
 values
 (nextval('seq_experimenter'),0,'${db.user}','My','Name');

 insert into groupexperimentermap
 (id, version, owner_id, group_id, creation_id, child, parent)
 select nextval('seq_groupexperimentermap'), 0, 0, 0, 0, e.id, g.id
 from experimenter e, experimentergroup g
 where e.omename = '${db.user}' and g.name = 'user';
                        </transaction>
                </sql_run>
	</target>

	<target name="cache">
		<java classname="InitializeHibernateTest" classpathref="omero.classpath" fork="yes" failonerror="yes" />
	</target>

</project>
