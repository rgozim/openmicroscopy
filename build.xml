<?xml version="1.0" encoding="utf-8"?>
<project name="services" default="install" basedir=".">

    <property name="artifact.name" value="server"/>
    <property name="artifact.group" value="omero"/>
    <property name="artifact.version" value="3.0-TRUNK"/>
    <property name="artifact.packaging" value="jar"/><!-- Default; override in component/build.xml -->
    <property name="artifact.final.name" value="server-3.0-TRUNK.${artifact.packaging}"/>
    <property name="artifact.path" value="omero/server/3.0-TRUNK/${artifact.final.name}"/>

    <property name="import.dir" value="${basedir}/../antlib/resources"/>
    <import file="${import.dir}/global.xml"/>
    <import file="${import.dir}/dependencies.xml"/>
    <import file="${import.dir}/lifecycle.xml"/>
    <import file="${import.dir}/hibernate.xml"/>

    <target name="prepare" depends="lifecycle.prepare">
      <presetdef name="sql_run">
	<sql
           driver="${hibernate.connection.driver_class}"
           url="${hibernate.connection.url}"
           userid="${hibernate.connection.username}"
           password="${hibernate.connection.password}" 
	   print="false" 
	   classpathref="omero.classpath">
	</sql>
      </presetdef>
    </target>

    <target name="check-db" depends="prepare">
      <sql_run>
	<transaction> select 'database exists.' </transaction>
      </sql_run>
    </target>

    <target name="reload-db" depends="prepare">
        <java classname="ome.security.PasswordUtil" outputproperty="ROOTPASS" classpathref="omero.classpath">
            <arg value="${omero.rootpass}"/>
        </java>
        <copy file="${sql.dir}/${omero.dbversion}__${omero.dbpatch}__schema.sql" tofile="${target.dir}/ddl.sql"  overwrite="true"/>
        <copy file="${sql.dir}/${omero.dbversion}__${omero.dbpatch}__data.sql" tofile="${target.dir}/data.sql"  overwrite="true"/>
        <replace file="${target.dir}/data.sql" token="@ROOTPASS@" value="${ROOTPASS}"/>
        <replace file="${target.dir}/data.sql" token="@DBPATCH@" value="${omero.dbpatch}"/>
        <sql_run>
            <transaction src="${target.dir}/ddl.sql"/>
            <transaction src="${target.dir}/data.sql"/>
        </sql_run>
    </target>

    <target name="compile" depends="generate">
        <hardWireCompile pattern="ome/services/util/OmeroAroundInvoke"
            token="&quot;ome.security.basic.BasicSecurityWiring&quot;"/>

    </target>

   <target name="initdb" depends="compile">
        <taskdef classname="ome.tools.DbUpdateTask" classpathref="omero.classpath" name="dbUpdate"/>
        <dbUpdate sqldir="${sql.dir}" classpathref="omero.classpath"
            driver="${hibernate.connection.driver_class}"
            url="${hibernate.connection.url}"
            userid="${hibernate.connection.username}"
            password="${hibernate.connection.password}" 
         />
    </target>

</project>
