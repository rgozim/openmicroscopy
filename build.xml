<?xml version="1.0" encoding="utf-8"?>
<!-- TODO add properties goal to update pref.properties -->
<project name="common" default="all" basedir=".">
    
	<dirname property="up-one" file="${basedir}"/>
	<import file="${up-one}/antlib/resources/build.xml"/>
	
	<!-- Local properties -->
	<property name="ddl.file" value="ddl.sql" />
	
	<target name="all" depends="dsl,hib,api"/>
	
	<target name="prepare" depends="global.prepare,loadHibernate"/>

    <!-- = = = = = = = = = = = = = = = = =
          home grown code-gen          
         = = = = = = = = = = = = = = = = = -->
	
	<target name="dsl-init" depends="prepare">
		<taskdef classname="ome.dsl.DSLTask" classpathref="local.classpath" name="dsl"/>
		<is-done name="dsl" srcdir="${resrc.dir}" includes="${dsl.pat}"/>
	</target>
	
	<target name="dsl" depends="dsl-init" unless="dsl.not.required">
		<mkdir dir="${hbm.dir}"/>
		<dsl destdir="${hbm.dir}/">
			<fileset dir="${resrc.dir}">
				<include name="${dsl.pat}"/>
			</fileset>
		</dsl>
		<done name="dsl"/>
	</target>

	<target name="api-init" depends="prepare">
		<taskdef classname="ome.dsl.APITask" classpathref="local.classpath" name="api"/>
		<is-done name="api" srcdir="${src.dir}/ome/api" includes="${api.pat}"/>
	</target>
	
	<target name="api" depends="api-init" unless="api.not.required">
		<mkdir dir="${api.dir}"/>
		<api destdir="${api.dir}/">
			<fileset dir="${src.dir}/ome/api">
				<include name="${api.pat}"/>
			</fileset>
		</api>
		<done name="api"/>
	</target>
	
    <!-- = = = = = = = = = = = = = = = = =
          hibernate code-gen  
         = = = = = = = = = = = = = = = = = -->
	
	<target name="hib-init" depends="prepare">
		<is-done name="hib" srcdir="${hbm.dir}" includes="${hbm.pat}"/>
	</target>
	
	<target name="hib" depends="dsl,hib-init" unless="hib.not.required">
		<mkdir dir="${dest.dir}/jdk14"/>
		<hibernate>			
			<hbm2java destdir="${dest.dir}/jdk14"/>
			<!-- hbm2java destdir="${dest.dir}/jdk5" generics="true" ejb3="true"/ -->
			<hbm2ddl outputfilename="${ddl.file}" export="true" console="false" />
			<hbm2cfgXml destdir="${hbm.dir}"/>
		</hibernate>
		<done name="hib"/>
		<delete>
			<fileset dir="${dest.dir}/jdk14" includes="**/*.java">
				<present present="both" targetdir="${src.dir}"/>
			</fileset>
		</delete>
	</target>

    <!-- = = = = = = = = = = = = = = = = =
          misc          
         = = = = = = = = = = = = = = = = = -->
	
	<target name="cache">
		<java classname="InitializeHibernateTest" classpathref="local.classpath" fork="yes" failonerror="yes" />
	</target>

</project>
