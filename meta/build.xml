<?xml version="1.0" encoding="utf-8"?>


<!-- TODO add properties goal to update pref.properties -->

<project name="Middlegen Hibernate" default="all" basedir=".">
   <property file="${basedir}/mgen.properties"/>
   <property name="hibernate.cascade"    value="all" />
   <property name="package"              value="ome.model" />
   <property name="gen.xdoclet-tag"      value="true" />
   <property name="gui"                  value="false" />
   <property name="lib.dir"              value="${basedir}/lib/" />
   <property name="dest.dir"             value="${basedir}" />

   <target name="ant">
     <ant/>
   </target>

   <target name="init" depends="prepare,fail-if-no-middlegen,fail-if-no-hibernate,fail-if-no-hibernate-ext" >

     <taskdef
        name="middlegen"
        classname="middlegen.MiddlegenTask"
        classpathref="middlegen.classpath"
     />

     <taskdef 
        classname="org.hibernate.tool.ant.HibernateToolTask"
        classpathref="hibernate-ext.classpath" 
        name="hibernatetool">
     </taskdef>

    <mkdir dir="${dest.dir}"/>
   
   </target>

   <target name="prepare" >

     <path id="middlegen.classpath">
        <pathelement path="${maven.classpath}"/>
        <fileset dir="${lib.dir}/middlegen" includes="*.jar"/>
        <fileset dir="/home/josh/.maven/repository/postgresql/jars/"
	  includes="postgresql-7.4.1-jdbc3.jar"/>
     </path>

     <path id="hibernate-ext.classpath">
       <fileset dir="${lib.dir}/hibernate3" includes="*.jar"/>
       <pathelement location="${dest.dir}/"/>
     </path>

     <available property="middlegen" classname="middlegen.MiddlegenTask" classpathref="middlegen.classpath"/>
     <available property="hibernate" classname="org.hibernate.Hibernate" classpathref="hibernate-ext.classpath"/>
     <available property="hibernate-ext" classname="org.hibernate.tool.ant.HibernateToolTask" classpathref="hibernate-ext.classpath"/>

   </target>

   <target name="fail-if-no-middlegen" unless="middlegen">
      <fail>
      Middlegen is not found. Please install Middlegen.
      </fail>
   </target>

   <target name="fail-if-no-hibernate" unless="hibernate">
      <fail>
      Hibernate is not found. Please install Hibernate.
      </fail>
   </target>

   <target name="fail-if-no-hibernate-ext" unless="hibernate-ext">
      <fail>
      Hibernate-Extension is not found. Please install Hibernate-Extenstion.
      </fail>
   </target>
    
   <target name="gen-hbm" depends="init" unless="middlegen.not.required">

    <middlegen
         appname="${package}"
         prefsdir="${basedir}"
         gui="${gui}"
         databaseurl="${database.url}"
         driver="${database.driver}"
         username="${database.username}"
         password="${database.password}"
      >
<!--
         schema="${database.schema}"
         catalog="${database.catalog}"
  	<many2many>
	  <tablea name="projects"/>
	  <jointable name="project_dataset_map" generate="false"/>
	  <tableb name="datasets"/>
	</many2many>
  	<many2many>
	  <tablea name="datasets"/>
	  <jointable name="image_dataset_map" generate="false"/>
	  <tableb name="images"/>
	</many2many>
  	<many2many>
	  <tablea name="experimenters"/>
	  <jointable name="experimenter_group_map" generate="false"/>
	  <tableb name="groups"/>
	</many2many>
	<table name="module_executions"/>
	<table name="classification"/>
	<table name="categories"/>
	<table name="category_groups"/>
	<table name="image_pixels"/>
	<table name="dataset_annotations"/>
	<table name="image_annotations"/>
	<table name="image_dimensions"/>
	<table name="image_info"/>
	<table name="channel_components"/>
	<table name="features"/>
	<table name="thumbnails"/>
	<table name="repositories"/>
	<table name="logical_channels"/>
	<table name="rendering_settings"/>
	<table name="semantic_type_outputs"/>
	<table name="semantic_types"/>
	<table name="semantic_elements"/>
	<table name="modules"/>
	<table name="ome_sessions"/>
	<table name="analysis_chains"/>
	<table name="analysis_chain_nodes"/>
	<table name="analysis_chain_links"/>
	<table name="analysis_chain_executions"/>
	<table name="analysis_node_executions"/>
	<table name="formal_inputs"/>
	<table name="formal_outputs"/>
-->

         <hibernate
            destination="${dest.dir}"
            package="${package}"
            genXDocletTags="${gen.xdoclet-tag}"
       	    standardCascade="${hibernate.cascade}"
	    standardGeneratorScheme="sequence"
	    standardGeneratorArg="{0}_seq"
	    javaTypeMapper="middlegen.plugins.hibernate.HibernateJavaTypeMapper"
	    equalsHashcode="true"
 	    versionUnsavedValueSimpleKey="true"
	 >
  	 
<!-- TODO 
	<implements>ome.api.OMEModel</implements>
OR
	implements="ome.api.OMEModel" 
-->
	 </hibernate>
    </middlegen>
  </target>

  <target depends="init" name="gen-java" unless="middlegen.not.required">
    <hibernatetool>
      <configuration>
        <fileset dir="${dest.dir}" id="id">
          <include name="**/*.hbm.xml"></include>
        </fileset>
      </configuration>
      <hbm2java destdir="${dest.dir}">
      </hbm2java>
    </hibernatetool>
  </target>

  <target name="all" unless="middlegen.not.required">
    <antcall target="gen-hbm"/>
    <antcall target="gen-java"/>
  </target>

  <target name="cache">
    <java classname="InitializeHibernateTest"
          classpathref="hibernate-ext.classpath" 
          fork="yes"
          failonerror="yes"/>
  </target>

</project>
