<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="http://www.springframework.org/schema/beans
           http://www.springframework.org/schema/beans/spring-beans-2.5.xsd"
       default-lazy-init="true">
<!--
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#
# $Id$
#
# Copyright 2006 University of Dundee. All rights reserved.
# Use is subject to license terms supplied in LICENSE.txt
#
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
-->

<!--
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# Written by:  Josh Moore <josh.moore@gmx.de>
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
-->

  <description>
    Configuration for standalone properties and general database access.
    The beans in this configuration file should NOT be generally accessed.
    In general, this entire file should be considered to have a "private" scope.
    
    Note: As other forms of data access (caching esp. distributed, Freeze, etc.
    are added, they should also be configured at this level)
  </description>

  <!--  Scope: private -->

  <bean id="cacheManager" class="ome.tools.spring.ShutdownSafeEhcacheManagerFactoryBean"/>

  <bean id="innerDataSource" class="org.enhydra.jdbc.standard.StandardXADataSource" destroy-method="shutdown">
    <property name="transactionManager" ref="jotm"/>
    <property name="driverName" value="${hibernate.connection.driver_class}"/>
    <property name="url" value="${hibernate.connection.url}"/><!-- ?loglevel=2 -->
    <property name="user" value="${hibernate.connection.username}"/>
    <property name="password" value="${hibernate.connection.password}"/>
    <property name="maxCon" value="${c3p0.maxPoolSize}"/>
    <property name="minCon" value="${c3p0.minPoolSize}"/>
  </bean>

  <bean id="xaDataSource" class="org.enhydra.jdbc.pool.StandardXAPoolDataSource" destroy-method="shutdown">
    <property name="dataSource"><ref local="innerDataSource"/></property>
    <property name="maxSize" value="${c3p0.maxPoolSize}"/>
    <property name="minSize" value="${c3p0.minPoolSize}"/>
    <property name="user" value="${hibernate.connection.username}"/>
    <property name="password" value="${hibernate.connection.password}"/>
  </bean>

  <bean id="jotm" class="ome.tools.spring.JotmFactoryBean"/>

  <bean id="transactionManager" class="org.springframework.transaction.jta.JtaTransactionManager">
    <property name="userTransaction" ref="jotm"/>
  </bean>

  <bean id="transactionHandler"
        class="org.springframework.transaction.interceptor.TransactionInterceptor">
    <description>
    Scope: private
    </description>
    <property name="transactionManager" ref="transactionManager"/>
    <property name="transactionAttributeSource">
      <bean class="org.springframework.transaction.annotation.AnnotationTransactionAttributeSource"/>
    </property>
  </bean>

  <bean id="unsafeJdbcTemplate" class="org.springframework.jdbc.core.simple.SimpleJdbcTemplate">
    <description>
    Scope: private
    
    This template is "unsafe" since it does not take part Hibernate transactions
    and should only be used in cases where this is beneficial.
    </description>
    <constructor-arg ref="dataSource"/>
  </bean>

  <bean id="lobHandler" class="org.springframework.jdbc.support.lob.DefaultLobHandler"/>

  <!--
    DATA SOURCES
   -->

  <!-- To re-activate data source testing (see test/ome/server/itests/scalability)
  use the alias with ${dataSource} and define a dataSource property either in
  a configuration file, or directly in your tests via System.setProperty() *before*
  creating the Spring application context. -->
  <!--alias name="${dataSource}" alias="dataSource"/-->
  <alias name="xaDataSource" alias="dataSource"/>
  
  <bean id="loggingDataSource" class="ome.services.util.LoggingDataSource">
    <description>
    Scope: private
    
    Under extreme conditions, c3p0 can run out of connections at which time the
    server can come to a stand still. To catch this situation, the logging
    data source will now print to a special category which can be detected by
    log4j appenders and handled appropriately (sending email, etc.)
    </description>
    <constructor-arg ref="c3p0DataSource"/>
  </bean>
  
  <bean id="c3p0DataSource" lazy-init="true"
     class="com.mchange.v2.c3p0.ComboPooledDataSource" destroy-method="close">
    <description>
    Scope: private
    </description>
    <property name="driverClass" value="${hibernate.connection.driver_class}"/>
    <property name="jdbcUrl" value="${hibernate.connection.url}"/>
    <property name="user" value="${hibernate.connection.username}"/>
    <property name="password" value="${hibernate.connection.password}"/>
  </bean>

  <!-- Alternative data sources, used for testing -->
  <bean id="dbcpDataSource" class="org.apache.commons.dbcp.BasicDataSource">
      <property name="driverClassName" value="${hibernate.connection.driver_class}"/>
      <property name="url" value="${hibernate.connection.url}"/>
      <property name="username" value="${hibernate.connection.username}"/>
      <property name="password" value="${hibernate.connection.password}"/>
  </bean>

  <bean id="pgSimpleDataSource" class="org.postgresql.jdbc2.optional.SimpleDataSource">
      <property name="serverName" value="${database.host}"/>
      <property name="databaseName" value="${database.name}"/>
      <property name="user" value="${hibernate.connection.username}"/>
      <property name="password" value="${hibernate.connection.password}"/>
  </bean>

  <bean id="springSingleDataSource" class="org.springframework.jdbc.datasource.SingleConnectionDataSource">
      <property name="driverClassName" value="${hibernate.connection.driver_class}"/>
      <property name="url" value="${hibernate.connection.url}"/>
      <property name="username" value="${hibernate.connection.username}"/>
      <property name="password" value="${hibernate.connection.password}"/>
      <property name="suppressClose" value="true"/>
  </bean>

</beans>
