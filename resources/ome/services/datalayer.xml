<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="http://www.springframework.org/schema/beans
           http://www.springframework.org/schema/beans/spring-beans-2.5.xsd"
       default-lazy-init="true">
<!--
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#
# $Id$
#
# Copyright 2006 University of Dundee. All rights reserved.
# Use is subject to license terms supplied in LICENSE.txt
#
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
-->

<!--
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# Written by:  Josh Moore <josh.moore@gmx.de>
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
-->

  <description>
    Configuration for standalone properties and general database access.
    The beans in this configuration file should NOT be generally accessed.
    In general, this entire file should be considered to have a "private" scope.
    
    Note: As other forms of data access (caching esp. distributed, Freeze, etc.
    are added, they should also be configured at this level)
  </description>

  <!-- 
        Unique identifier for this Spring context. This is important to
        distinguish multiple uses of the same database, for example in clustering.
        This value may also be used as the internal session for this server instance
  -->
  <bean id="uuid_object" class="java.util.UUID" factory-method="randomUUID"/>
  <bean id="uuid" factory-bean="uuid_object" factory-method="toString"/>

  <!--  Scope: private -->

  <bean id="cacheManager" class="ome.tools.spring.ShutdownSafeEhcacheManagerFactoryBean"/>

  <bean id="btmConfig" factory-method="getConfiguration"
        class="bitronix.tm.TransactionManagerServices">
    <property name="serverId" ref="uuid" />
    <property name="disableJmx" value="true" />
    <property name="defaultTransactionTimeout" value="600"/>
  </bean>

  <alias name="onePcDataSource" alias="dataSource"/>

  <bean abstract="true" id="btmDataSource">
    <property name="uniqueName" ref="uuid" />
    <property name="minPoolSize" value="5" />
    <property name="maxPoolSize" value="${omero.db.poolsize}" />
    <property name="allowLocalTransactions" value="false" />
  </bean>

  <bean id="xaDataSource"
        class="bitronix.tm.resource.jdbc.PoolingDataSource"
        lazy-init="true"
        init-method="init"
        destroy-method="close"
        parent="btmDataSource">
    <property name="className" value="org.postgresql.xa.PGXADataSource"/>
    <property name="driverProperties">
      <props>
        <prop key="user">${omero.db.user}</prop>
        <prop key="password">${omero.db.pass}</prop>
        <prop key="databaseName">${omero.db.name}</prop>
        <prop key="serverName">${omero.db.host}</prop>
        <prop key="portNumber">5432</prop>
      </props>
    </property>
  </bean>

  <bean id="onePcDataSource"
        class="bitronix.tm.resource.jdbc.PoolingDataSource"
        lazy-init="true"
        init-method="init"
        destroy-method="close"
        parent="btmDataSource">
    <property name="className" value="bitronix.tm.resource.jdbc.lrc.LrcXADataSource"/>
    <property name="driverProperties">
      <props>
        <prop key="driverClassName">org.postgresql.Driver</prop>
        <prop key="url">jdbc:postgresql://${omero.db.host}/${omero.db.name}</prop>
        <prop key="user">${omero.db.user}</prop>
        <prop key="password">${omero.db.pass}</prop>
      </props>
    </property>
  </bean>

  <bean id="BitronixTransactionManager"
        factory-method="getTransactionManager"
        class="bitronix.tm.TransactionManagerServices"
        depends-on="btmConfig,dataSource"
        destroy-method="shutdown" />

  <bean id="btmDeployer" class="ome.tools.hibernate.BitronixTransactionManagerLookup">
    <description>Binds the two arguments into JNDI</description>
    <constructor-arg ref="dataSource"/>
    <constructor-arg ref="BitronixTransactionManager"/>
  </bean>

  <bean id="transactionManager" depends-on="btmDeployer"
        class="org.springframework.transaction.jta.JtaTransactionManager">
    <property name="transactionManager" ref="BitronixTransactionManager" />
    <property name="userTransaction" ref="BitronixTransactionManager" />
  </bean>

  <bean id="transactionHandler"
        class="org.springframework.transaction.interceptor.TransactionInterceptor">
    <description>
      Scope: private
    </description>
    <property name="transactionManager" ref="transactionManager"/>
    <property name="transactionAttributeSource">
      <bean class="org.springframework.transaction.annotation.AnnotationTransactionAttributeSource"/>
    </property>
  </bean>

  <bean id="transactionTemplate" class="org.springframework.transaction.support.TransactionTemplate">
    <constructor-arg ref="transactionManager"/>
  </bean>

  <bean id="simpleJdbcTemplate" class="org.springframework.jdbc.core.simple.SimpleJdbcTemplate">
    <description>
    Scope: private

    Users of JDBC Templates may need to manage their own transactions if they
    don't expect to be part of an existing JTA transaction.
    </description>
    <constructor-arg ref="dataSource"/>
  </bean>

  <bean id="lobHandler" class="org.springframework.jdbc.support.lob.DefaultLobHandler"/>

  <bean id="loggingDataSource" class="ome.services.util.LoggingDataSource" lazy-init="true">
    <description>
    Scope: private

    Under extreme conditions, the data source can run out of connections at which time the
    server can come to a stand still. To catch this situation, the logging
    data source will now print to a special category which can be detected by
    log4j appenders and handled appropriately (sending email, etc.)
    </description>
    <constructor-arg ref="dataSource"/>
  </bean>

</beans>

